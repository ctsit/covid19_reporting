---
title: "First Responder Covid-19 Report"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)

library(tidyverse)
library(dotenv)
library(REDCapR)
library(lubridate)
library(kableExtra)

source("functions.R")

# set the timezone
script_run_time <- with_tz(now(), tzone = Sys.getenv("TIME_ZONE"))

project_start_date <- ymd("2020-04-08")
current_date <- as_date(script_run_time) - 1
```

Since we do not specifically track ‘No-Show’ appointments for this study we are operating under the assumption that if the appointment occurred and 48 hours elapsed without a test result being entered then the subject did not show up for their appointment and thus had no sample collected.
For subjects with multiple tests priority is given to positive swab results

```{r}
# read appointment data betewwen 2020-04-08 and current_date 
records <- get_records(raw_or_label = "label") %>% 
  mutate(test_date_and_time = as_date(test_date_and_time),
         days_since_appt = current_date - test_date_and_time) %>% 
  filter(between(test_date_and_time, project_start_date, current_date))  
  
records <- records %>%
  # priority is given to positive results when there are multiple tests per subject
  arrange(record_id, desc(covid_19_swab_result)) %>% 
  mutate(
    q_agency = str_to_title(
      case_when(is.na(q_agency) ~ "Unknown Agency",
                TRUE ~ q_agency)),
    covid_19_swab_result = case_when(
      days_since_appt > 2 & is.na(covid_19_swab_result) ~ "No Show",
      days_since_appt <= 2 & is.na(covid_19_swab_result) ~ "Waiting for Results",
      TRUE ~ covid_19_swab_result)) %>% 
  # select a unique subject
  distinct(record_id, .keep_all = T) %>% 
  select("Agency" = q_agency, covid_19_swab_result, test_date_and_time)

result_total <- records %>%
  count(covid_19_swab_result) %>% 
  pivot_wider(names_from = covid_19_swab_result, values_from = n) %>%  
  mutate(Total = rowSums(.[,])) %>% 
  mutate_all(as.character) %>% 
  add_column("Agency" = 'Overall Total')

appt_by_agency <- records %>% 
  count(Agency, covid_19_swab_result) %>%  
  group_by(Agency) %>% 
  mutate(perc = round(n/sum(n),2)*100,
         Total = sum(n),
         n = paste0(n, " (", perc,"%)")) %>% 
  select(-perc) %>% 
  ungroup() %>% 
  pivot_wider(names_from = covid_19_swab_result, values_from = n) %>% 
  select(Agency, Negative, `No Show`, `Waiting for Results`, Positive, Total) %>%
  mutate_all(as.character) %>% 
  bind_rows(result_total) %>% 
  mutate_all(replace_na, 0)

kable(appt_by_agency, "latex", booktabs = T,
      caption = paste("Covid-19 Appointment Outcome by Agency for",  
                       project_start_date, "to", current_date)) %>% 
  kable_styling(latex_options = c("striped", "hold_position", "scale_down"))
```

```{r fig.align="center", fig.width=12, fig.height=6}
appt_over_time <- records %>%
  count(test_date_and_time, covid_19_swab_result) %>% 
  filter(covid_19_swab_result != 'Waiting for Results')

ggplot(appt_over_time, aes(x = test_date_and_time, y = n, 
                           color = covid_19_swab_result))+
  geom_line()+
  geom_point()+
  scale_y_continuous(breaks = seq(0, max(appt_over_time$n), by = 20))+
  scale_x_date(date_breaks = "2 day", date_labels = "%b-%d")+
  labs(x = "Appointment Date", y = "# Persons", 
       title = "Appointment Outcome Over Time",
       colour = "Outcome")+
  theme(plot.title = element_text(hjust = 0.5))
```
