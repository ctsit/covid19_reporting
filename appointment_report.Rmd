---
title: "First Responder Covid-19 Report"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)

library(tidyverse)
library(dotenv)
library(REDCapR)
library(lubridate)
library(kableExtra)

# set the timezone
Sys.setenv(TZ = Sys.getenv("TIME_ZONE"))

project_start_date <- ymd("2020-04-08")
current_date <- Sys.Date() - 1
```

Since we do not specifically track ‘No-Show’ appointments for this study we are operating under the assumption that if the appointment occurred and 48 hours elapsed without a test result being entered then the subject did not show up for their appointment and thus had no sample collected.


```{r}
# read appointment data betewwen 2020-04-08 and current_date 
records <- redcap_read_oneshot(redcap_uri = 'https://redcap.ctsi.ufl.edu/redcap/api/',
                               token = Sys.getenv("TOKEN"),
                               raw_or_label = "label")$data %>% 
  mutate(test_date_and_time = as_date(test_date_and_time),
         days_since_appt = current_date - test_date_and_time) %>% 
  filter(between(test_date_and_time, project_start_date, current_date))  
  
records <- records %>%
  mutate(
    q_agency = str_to_title(
      case_when(is.na(q_agency) ~ "Unknown Agency",
                TRUE ~ q_agency)),
    covid_19_swab_result = case_when(
      days_since_appt > 2 & is.na(covid_19_swab_result) ~ "No Show",
      days_since_appt <= 2 & is.na(covid_19_swab_result) ~ "Waiting for Results",
      TRUE ~ covid_19_swab_result)) %>%
  select("Agency" = q_agency, covid_19_swab_result, test_date_and_time)

appt_by_agency <- records %>% 
  count(Agency, covid_19_swab_result) %>%  
  group_by(Agency) %>% 
  mutate(perc = round(n/sum(n),2)*100,
         Total = sum(n),
         n = paste0(n, " (", perc,"%)")) %>% 
  select(-perc) %>% 
  ungroup() %>% 
  pivot_wider(names_from = covid_19_swab_result, values_from = n) %>% 
  mutate_all(replace_na, 0) %>% 
  select(Agency, Negative, `No Show`, `Waiting for Results`, Positive, Total)

kable(appt_by_agency, "latex", booktabs = T,
      caption = paste("Covid-19 Appointment Outcome by Agency for",  
                       project_start_date, "to", current_date)) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r fig.align="center", fig.width=12, fig.height=6}
appt_over_time <- records %>%
  count(test_date_and_time, covid_19_swab_result) %>% 
  filter(covid_19_swab_result != 'Waiting for Results')

ggplot(appt_over_time, aes(x = test_date_and_time, y = n, 
                           color = covid_19_swab_result))+
  geom_line()+
  geom_point()+
  scale_y_continuous(breaks = seq(0, max(appt_over_time$n), by = 20))+
  scale_x_date(date_breaks = "2 day", date_labels = "%b-%d")+
  labs(x = "Appointment Date", y = "# Persons", 
       title = "Appointment Outcome Over Time",
       colour = "Outcome")+
  theme(plot.title = element_text(hjust = 0.5))
```
